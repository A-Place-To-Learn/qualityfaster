machine:
  java:
    version: oraclejdk8
  node:
    version: 6.5.0

dependencies:
  cache_directories:
    - "node_modules"
    - "~/.npm"
    - "~/.meteor"

  override:
    # Cache npm deps
    - npm install

    # Cache Chimp's Selenium & ChromeDriver downloads
    - mkdir ./tmp && ./node_modules/.bin/chimp --path=./tmp && rm -rf ./tmp # there are no tests here

    # Cache Karma's dependencies
    - ./node_modules/.bin/karma start ./config/karma.config.js || true # we're not interested in testing at this stage

    # Cache Meteor
    - if [ -d ~/.meteor ]; then sudo ln -s ~/.meteor/meteor /usr/local/bin/meteor; fi
    - if [ ! -e $HOME/.meteor/meteor ]; then curl https://install.meteor.com | sh; fi

test:
  override:
    - npm test

deployment:
  production:
   branch: dev
   commands:
   # Use Node.js to decode and output the Base64 environment variable called METEOR_SESSION_FILE, then redirect the output to a file called meteor-session-file.json
   - node -e "console.log(new Buffer(process.env.METEOR_SESSION_FILE_CONTENT, 'Base64').toString('utf-8'))" > meteor-session-file.json
   # Next we tell Meteor deploy to use the session file, to deploy to app.qualityfaster.com and to use the production-settings.json
   - DEPLOY_HOSTNAME=galaxy.meteor.com METEOR_SESSION_FILE=meteor-session-file.json meteor deploy app.qualityfaster.com --settings production-settings.json
